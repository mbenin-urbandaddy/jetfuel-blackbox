#!/usr/bin/env node

var MODULES = 'node_modules',
    FORCE = '--force',
    ESPRESSO = './espresso';

var fs = require('fs'),
    path = require('path'),
    util = require('util'),
    puts = util.puts,
    args = process.argv.splice(2),
    pwd = process.cwd(),
    cwd = pwd.split('/'),
    projectName = cwd.pop(),
    dirName = cwd.pop(),
    target,
    modules;

if(dirName == MODULES) {
    try {
        if(fs.existsSync(target = cwd.concat(projectName).join('/')) && args[0] != FORCE) puts('\nTarget directory already exists: ' + target);
        else {
            fs.renameSync(pwd, target);
            puts('\nMoved project "' + projectName + '" (' + pwd + ') to target: ' + target);

            process.cwd(target);
            puts('\nChanged directory: ' + target);

            if(!fs.readdirSync(modules = path.resolve(target + '/../' + MODULES)).length) {
                fs.rmdirSync(modules);
                puts('\nRemoved empty modules directory: ' + modules);
            }
        }
    } catch(e) {
        util.error('\n' + e + '\n');
        process.exit(1);
    }
} else {
    puts('\nInstall directory is already the target directory.');
}

puts('\nExecuting: espresso install\n');

require('child_process')
    .spawn(ESPRESSO, ['install', '--force'], { customFds: [0, 0, 0] })
    .on('exit', function(code) {
        (code && util.error || puts)('\nEspresso install exited with: ' + code + '\n');
        if(code) process.exit(code);
    });
